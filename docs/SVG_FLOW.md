# Green Movement — SVG 애니메이션 흐름 정리

이 문서는 생성되는 `live.svg`에서 **우주선·양·잔디·꽃**이 어떤 순서로 움직이는지 정리한 것입니다.

---

## 전체 흐름 요약

1. **우주선 진입** → 잔디가 있는 곳이 **아닌** 빈 칸에 양을 한 마리씩 내린다.
2. **양**은 근처 잔디를 찾아 다니며 잔디를 뜯어 먹는다.
3. 양이 지나간 **빈 칸**에는 꽃이 핀다.
4. 잔디를 **다 먹고** 모든 양이 멈추면, 우주선이 양을 한 마리씩 **회수**한다.
5. 회수를 마친 우주선은 **그리드 중앙**으로 이동한 뒤, **파동**을 한 번 날린다. 파동이 그리드 끝까지 퍼지면서 **서클(페인트)** 이 완성된다.
6. 그 다음 **우주선 퇴장**.

---

## 1. 우주선이 빈 칸에 양을 한 마리씩 내린다

- **대상 칸**: GitHub 잔디가 **채워져 있는 칸이 아니라**, 그와 **인접한 빈 칸**이다.  
  “이 빈 칸에 내리면, 바로 옆 잔디를 먹을 수 있다”는 위치만 후보가 된다.
- **한 칸에 한 마리**: 각 양마다 서로 다른 빈 칸이 배정되며, 한 칸에 두 마리가 내려지지 않는다.
- **순서**: 우주선이 첫 번째 빈 칸에 도착 → 잠시 대기 → 빛(빔)이 내려오고 양이 내려짐 → 다음 빈 칸으로 이동 → 반복.  
  각 위치에서 “도착 → 빛 켜짐 → 양 등장 → 빛 꺼짐 후 출발” 타이밍이 맞춰져 있다.
- **관련 코드**: 드롭 위치 후보·배정은 `src/planning/targetPlanner.ts` (잔디 인접 빈 칸 BFS, `funnelPositionsEarly`), 우주선 이동·빛·리플은 `src/svg/anim/keyframes.ts`의 `buildUfoLayer`·`ufo-light` 키프레임.

---

## 2. 내린 양은 근처 잔디를 찾아 뜯어 먹는다

- **목표**: 각 양에게 “이 빈 칸에 내렸으니, 저 잔디 칸을 먹어라”가 플랜 단계에서 정해진다.  
  양은 그 **한 칸의 잔디**를 먹고, 필요하면 다른 잔디로 이동한다.
- **이동**: 빈 칸만 걸어다니며, BFS·경로 예약으로 서로 겹치지 않게 움직인다. 한 틱에 한 칸씩 이동한다.
- **먹기**: 잔디 칸에 도착하면 일정 시간 머무르며 “먹는” 연출이 되고, 그 칸의 잔디 색(레벨)이 서서히 사라진다(fade).
- **관련 코드**: 시뮬레이션·경로·잔디 소모는 `src/svg/sim/simulate.ts`, 타겟·경로 계획은 `src/planning/targetPlanner.ts`, 잔디 레이어·fade는 `src/svg/anim/keyframes.ts`의 잔디 레이어.

---

## 3. 양이 잔디를 먹으러 다니는 길에는 꽃이 핀다

- **조건**: 양이 **한 번도 잔디가 없었던 빈 칸**을 밟은 시점에, 그 칸에 꽃이 “피어난다”.
- **위치**: 같은 칸에 여러 송이가 칸 안에서 랜덤한 위치에 배치되며, 셀 크기(`CELL_SIZE`)에 비례해 스케일된다.
- **연출**: 해당 시각에 맞춰 꽃이 등장하는 키프레임(opacity·scale·약간의 트윙클)이 적용된다.
- **관련 코드**: 꽃이 피는 칸·시각 수집은 `src/svg/renderGridSvg.ts`의 `flowerListByCell`, 꽃 레이어·키프레임은 `src/svg/layers/flowerLayer.ts`.

---

## 4. 양이 잔디를 다 먹으면 우주선이 양을 한 마리씩 회수한다

- **시작 시점**: “잔디를 다 먹었다” = 시뮬레이션 상에서 **모든 양이 더 이상 움직이지 않고 멈춘 시점**이다.  
  이 시각을 기준으로 회수 단계가 시작된다. (이전에는 우주선이 남은 드롭 위치까지 모두 간 뒤에 회수했지만, 지금은 “모든 양이 멈춘 시점”부터 바로 회수한다.)
- **회수 순서**: 우주선은 **마지막으로 방문한 드롭 위치**에서 출발해, 각 양이 **현재 서 있는 칸**으로 한 마리씩 이동한다.  
  해당 칸 위에 도착 → 잠시 대기 → 빛을 켬 → 빛이 내려온 뒤 양이 서서히 사라짐(fade out) → 다음 양 위치로 이동.
- **관련 코드**: 회수 시작 시각·드롭 구간 자르기는 `src/timeline/schedules.ts`의 `allSheepDoneAbsS`, `effectiveDropCount`, 회수 이동·빛·양 fade는 `src/svg/anim/keyframes.ts`의 pickup 구간·`buildSheepLayer`의 pickup fade.

---

## 5. 우주선이 회수를 마치면 중앙에 가서 파동을 날리면, 파동이 그리드 끝까지 퍼지면서 서클이 완성된다

- **이동**: 회수한 우주선은 그리드 **정중앙** (열/행 기준 중앙 칸)으로 이동한다.
- **파동(리플)**: 중앙에 도착한 뒤, 그 위치를 중심으로 **동심원처럼 퍼지는 파동**이 한 번 발생한다.  
  링 1 → 2 → … → 그리드 끝까지 순서대로 퍼지며, 각 링이 잠깐 빛났다가 사라진다.
- **서클(페인트) 완성**: 파동이 **그리드 끝에 도달하는 시각**과, **중앙에서 거리순으로 셀을 “칠하는” 연출**이 맞춰져 있다.  
  즉, 파동이 퍼져 나가는 것과 동시에, 중앙에서 바깥으로 퍼지듯 **원형으로 색이 채워지는** 서클이 완성된다.  
  (실제로는 각 셀에 “이 시각에 이 색으로 칠해진다”는 페인트 맵/타이밍이 적용된다.)
- **관련 코드**: 중앙 좌표·파동·페인트 구간은 `src/timeline/schedules.ts`의 `paintCenterCol/Row`, `paintSweepDuration`, `PAINT_WAVE_SPEED_S`, 리플 키프레임·fullGridWave·`rippleStepS`는 `src/svg/anim/keyframes.ts`, 셀별 페인트 시각은 `src/svg/renderGridSvg.ts`의 `paintTimes`·거리 기반 계산.

---

## 6. 그 다음 우주선 퇴장

- **연출**: 중앙 파동·페인트가 끝난 뒤, 우주선이 화면 밖으로 **퇴장**하는 키프레임이 재생된다.  
  (진입했던 방향의 반대, 또는 정해진 퇴장 경로로 나간다.)
- **관련 코드**: 퇴장 구간은 `src/svg/anim/keyframes.ts`의 `buildUfoLayer` 마지막 부분(exit 키프레임), 전체 타임라인 길이에 `ufoExitS`가 포함되어 퇴장 시간이 확보된다.

---

## 참고: 타임라인·레이어

- **타임라인**: 위 1~6이 하나의 연속된 타임라인(초 단위)으로 계산된다.  
  `src/timeline/schedules.ts`의 `buildTimeline`이 “진입 → 드롭 → 회수 시작 → 회수 이동·회수 연출 → 중앙 도착 → 파동·페인트 → 퇴장” 순서와 각 구간 길이를 정한다.
- **레이어**: 잔디, 울타리, 꽃, 양, 우주선(본체·빛·리플)이 각각 레이어로 그려지며, 같은 타임라인(초)을 기준으로 키프레임이 동기화되어 있다.

이 흐름을 바꾸고 싶다면, 위에서 안내한 파일들(타임라인·keyframes·레이어)을 보면서 해당 단계의 타이밍·위치·조건을 수정하면 된다.
